<!DOCTYPE>
<html>
	<head>
		<title>С Днём Рождения!</title>
		<script type="text/javascript">

			function rand(min, max) {
				var rand = min - 0.5 + Math.random() * (max - min + 1)
				rand = Math.round(rand);
				return rand;
			}

			function randRange(amplitude) {
				return Math.random() * 2 * amplitude - amplitude;
			}

			function getDataFromImage(image)
			{
				var cnvs = document.createElement('canvas');
				var context = cnvs.getContext('2d');
				cnvs.width = image.width;
				cnvs.height = image.height;
				context.drawImage(image, 0, 0 );
				return context.getImageData(0, 0, image.width, image.height);
			}

			var dots = new Array();
			var star = new Image();
			var starData;

			function init()
			{
				for(i=0;i<5000;i++)
				{
					dots[i] = new Object();
					dots[i].x = rand(0, 800);
					dots[i].y = rand(0, 800);
					dots[i].whereX = dots[i].x;
					dots[i].whereY = dots[i].y;
				}

				star.src = "star.bmp";
				star.onload = function() {
					starData = getDataFromImage(star);
					setDots();
				};
				
				window.requestAnimationFrame(update);
			}

			function setDots()
			{
				var k = 0;
				for (var i=0; i<starData.height; i+=5)
					for (var j=0; j<starData.width; j+=5)
					{
						if (starData.data[(i*starData.width+j)*4] == 0)
						{
							dots[k].whereY = i;
							dots[k].whereX = j;
							k++;
						}
					}
			}


			function update(){
				var canvas = document.getElementById('tutorial');
				if (canvas.getContext){
					var ctx = canvas.getContext('2d');
					ctx.clearRect(0,0,800,800);
					ctx.fillStyle = 'rgba(255,100,0,1)';
					ctx.strokeStyle = 'rgba(0,153,255,0.4)';
					
					for(i=0;i<5000;i++)
					{
						vel = Math.sqrt((dots[i].whereX-dots[i].x)*(dots[i].whereX-dots[i].x) + (dots[i].whereY-dots[i].y)*(dots[i].whereY-dots[i].y))
						dots[i].x += (dots[i].whereX/vel)*3;
						dots[i].y += (dots[i].whereY/vel)*3;
						//dots[i].x+=randRange(1);
						//dots[i].y+=randRange(1);
						ctx.fillRect(dots[i].x,dots[i].y,5,5);
						
					}

					window.requestAnimationFrame(update);
				}
			}

		</script>
		<style type="text/css">
			canvas { border: 1px solid black; }
		</style>
	</head>
	<body onload="init();">
		<canvas width="800px" height="800px" id="tutorial"></canvas>
	</body>
</html>